<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submit New Samples</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
      }

      .chart-area {
        width: 40%;
        padding: 20px;
        min-height: 600px; /* ✅ Set minimum height */
        box-sizing: border-box;
      }

      h1 {
        text-align: center;
        margin-top: 20px;
      }

      .container {
        display: flex;
        margin-top: 30px;
        padding: 0 20px;
      }

      .sidebar {
        width: 20%;
        padding: 20px;
        background-color: #f9f9f9;
        border-right: 1px solid #ccc;
      }

      .result-area {
        width: 40%;
        padding: 20px;
      }

      .chart-area {
        width: 40%;
        padding: 20px;
      }

      .section {
        margin-bottom: 20px;
      }

      .error-message {
        color: #d9534f;
        font-weight: bold;
        margin-top: 10px;
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        cursor: pointer;
      }

      table,
      th,
      td {
        border: 1px solid #ccc;
      }

      th,
      td {
        padding: 8px;
        text-align: center;
      }

      th {
        background-color: #f2f2f2;
      }

      canvas {
        margin-top: 20px;
      }

      button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 10px;
      }

      button:hover {
        background-color: #0056b3;
      }

      .drug-pill {
        padding: 8px 16px;
        border-radius: 10px;
        background-color: #e0e0e0;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
      }

      .drug-pill.active {
        background-color: #007bff;
        color: white;
      }

      .selected-sample-row {
        background-color: #d4edda !important; /* light green */
      }

      .container,
      .sidebar,
      .result-area,
      .chart-area,
      .matching-section {
        background-color: white;
      }

      .mode-pill {
        padding: 6px 14px;
        border-radius: 15px;
        background-color: #eee;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        border: 1px solid #ccc;
      }
      .mode-pill.active {
        background-color: #007bff;
        color: white;
        border: 1px solid #007bff;
      }
    </style>
  </head>
  <body>
    <h1>Submit New Samples</h1>

    <div class="container">
      <div class="sidebar">
        <div class="section">
          <strong>Upload 1 sample</strong><br /><br />
          <input type="file" id="single-upload" multiple /><br />
        </div>
        <div class="section">
          <strong>Upload in batch</strong><br /><br />
          <input type="file" id="batch-upload" multiple /><br />
        </div>
        <div class="section">
          <strong>Enter Case ID:</strong><br />
          <input
            type="text"
            id="case-id-input"
            placeholder="Enter Case ID"
          /><br />
        </div>

        <button onclick="validateUploads()">Submit</button>
        <button
          id="save-button"
          onclick="saveSamplesLocally()"
          style="display: none; background-color: green"
        >
          Save Sample(s)?
        </button>
        <button
          id="print-button"
          onclick="printReport()"
          style="display: none; background-color: darkred"
        >
          Print Report
        </button>

        <div id="error-message" class="error-message"></div>
      </div>

      <div class="result-area">
        <h3>Results</h3>
        <table id="results-table">
          <thead>
            <tr>
              <th>Case ID</th>
              <th>Sample ID</th>
              <th>Drug Type</th>
              <th>Retention Time</th>
              <th>Maximum Abundance</th>
              <th>Spectrum Match %</th>
              <!-- ✅ New Column -->
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="chart-area">
        <div
          id="mode-toggle"
          style="display: flex; gap: 10px; margin-bottom: 15px"
        >
          <div class="mode-pill active" data-mode="info">Info</div>
          <div class="mode-pill" data-mode="spectrum">Compare Spectrum</div>
          <div class="mode-pill" data-mode="peaks">View Peaks</div>
        </div>

        <div id="chart-mode-container">
          <h4>Cocaine Spectrum Reference</h4>
          <canvas id="referenceChart" width="400" height="200"></canvas>
          <h4>Sample Spectrum</h4>
          <div
            id="match-info"
            style="
              margin-bottom: 10px;
              font-weight: bold;
              color: #333;
              font-size: 14px;
            "
          ></div>
          <canvas id="sampleChart" width="400" height="200"></canvas>
        </div>

        <div
          id="info-mode-container"
          style="display: none; font-size: 14px; line-height: 1.5"
        ></div>

        <div id="peaks-mode-container" style="display: none">
          <label for="peaks-dropdown"><strong>Show Peaks:</strong></label>
          <select id="peaks-dropdown">
            <option value="5" selected>Top 5</option>
            <option value="10">Top 10</option>
          </select>

          <div style="max-height: 250px; overflow-y: auto; margin-top: 10px">
            <table
              id="peaks-table"
              style="width: 100%; border-collapse: collapse"
            >
              <thead>
                <tr>
                  <th>Peak</th>
                  <th>Abundance</th>
                  <th>Retention Time</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <canvas id="peaksChart" height="250"></canvas>
        </div>
      </div>
    </div>

    <h1 style="text-align: center">All Saved Samples</h1>
    <div class="matching-section" style="width: 100%; margin-top: 5px">
      <div style="display: flex; width: 100%">
        <!-- Left 50%: All Samples Table -->
        <div style="width: 100%; padding: 20px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0px;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 0px;
              "
            >
              <label for="case-filter"
                ><strong>Filter by Case ID:</strong></label
              >
              <select id="case-filter">
                <option value="">All</option>
                <option value="C1">C1</option>
                <option value="C2">C2</option>
                <option value="C3">C3</option>
                <option value="C4">C4</option>
              </select>
            </div>

            <!-- Filter Buttons -->
            <div
              id="drug-filters"
              style="display: flex; gap: 8px; flex-wrap: wrap"
            >
              <div class="drug-pill" data-drug="Cocaine">Cocaine</div>
              <div class="drug-pill" data-drug="Heroin">Heroin</div>
              <div class="drug-pill" data-drug="Methamphetamine">
                Methamphetamine
              </div>
            </div>

            <!-- Total Samples Count -->
            <div style="text-align: right">
              <div style="font-size: 50px; font-weight: bold" id="sample-count">
                20
              </div>
              <div style="font-size: 15px; color: #555">Total Samples</div>
            </div>
          </div>

          <h3>All Samples</h3>
          <div
            style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc"
          >
            <table
              id="all-samples-table"
              border="1"
              cellpadding="8"
              style="width: 100%; border-collapse: collapse"
            >
              <thead
                style="position: sticky; top: 0; background-color: #f1f1f1"
              >
                <tr>
                  <th>Case ID</th>
                  <th>Sample ID</th>
                  <th>Drug Type</th>
                  <th>Retention Time</th>
                  <th>Maximum Abundance</th>
                  <th>Submission Time</th>
                </tr>
              </thead>
              <tbody>
                <!-- Preloaded + new rows go here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <h1 style="text-align: center">Drug Sample Matching</h1>
    <h4 style="text-align: center">
      Explore the matching samples with close retention times to the selected
      sample. By adjusting the slider, the samples with a difference in
      retention time within the allowed variance (±) will be filtered and
      displayed.
    </h4>
    <div class="matching-section" style="width: 100%; margin-top: 30px">
      <div style="display: flex; width: 100%">
        <!-- Left 50%: All Samples Table -->
        <div style="width: 50%; padding: 20px">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <!-- Filter Buttons -->
            <div
              id="drug-filters"
              style="display: flex; gap: 8px; flex-wrap: wrap"
            >
              <div class="drug-pill" data-drug="Cocaine">Cocaine</div>
              <div class="drug-pill" data-drug="Heroin">Heroin</div>
              <div class="drug-pill" data-drug="Methamphetamine">
                Methamphetamine
              </div>
            </div>

            <!-- Total Samples Count -->
            <div style="text-align: right">
              <div style="font-size: 50px; font-weight: bold" id="sample-count">
                20
              </div>
              <div style="font-size: 15px; color: #555">Total Samples</div>
            </div>
          </div>

          <h3>All Samples</h3>
          <div
            style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc"
          >
            <table
              id="all-samples-table"
              border="1"
              cellpadding="8"
              style="width: 100%; border-collapse: collapse"
            >
              <thead
                style="position: sticky; top: 0; background-color: #f1f1f1"
              >
                <tr>
                  <th>Sample ID</th>
                  <th>Drug Type</th>
                  <th>Retention Time</th>
                  <th>Maximum Abundance</th>
                  <th>Submission Time</th>
                </tr>
              </thead>
              <tbody>
                <!-- Preloaded + new rows go here -->
              </tbody>
            </table>
          </div>
        </div>

        <div style="width: 50%; padding: 20px">
          <div style="margin-bottom: 10px">
            <!-- Slider and Match Counter Side-by-Side -->
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-bottom: 10px;
              "
            >
              <!-- Slider with label -->
              <div style="width: 50%">
                <label style="font-weight: bold"
                  >Allowed Variance: <span id="variance-value">1.0</span></label
                ><br />
                <input
                  id="variance-slider"
                  type="range"
                  min="0"
                  max="2"
                  step="0.1"
                  value="1.0"
                  style="width: 100%"
                />
                <!-- Ticks below slider -->
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    font-size: 12px;
                    margin-top: 2px;
                  "
                >
                  <span>0</span>
                  <span>2</span>
                </div>
              </div>

              <!-- Match Count aligned to right -->
              <div style="text-align: right">
                <div
                  style="font-size: 50px; font-weight: bold"
                  id="match-count"
                >
                  0
                </div>
                <div style="font-size: 15px; color: #555">
                  Found Matches within ±<span id="variance-display-label"
                    >1.0</span
                  >
                  variance
                </div>
              </div>
            </div>
          </div>

          <h3>Found Matches</h3>
          <div
            style="max-height: 500px; overflow-y: auto; border: 1px solid #ccc"
          >
            <table
              id="found-matches-table"
              border="1"
              cellpadding="8"
              style="width: 100%; border-collapse: collapse"
            >
              <thead
                style="position: sticky; top: 0; background-color: #f1f1f1"
              >
                <tr>
                  <th>Sample ID</th>
                  <th>Drug Type</th>
                  <th>Retention Time</th>
                  <th>Maximum Abundance</th>
                  <th>Submission Time</th>
                  <th>Difference</th>
                  <!-- New column -->
                </tr>
              </thead>

              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const chromFiles = {}; // sampleID => CHROMTAB content

      const sampleRetention = {}; // sampleID => retentionTime
      const sampleAbundance = {}; // sampleID => maxAbundance

      const referenceSpectrum = {
        40.1: 39968,
        41.1: 281344,
        42.1: 1018112,
        43.1: 66024,
        44.1: 154368,
        45.1: 37216,
        46.2: 1176,
        47.0: 519,
        47.7: 1005,
        48.1: 969,
        50.1: 181056,
        51.1: 679744,
        52.1: 76704,
        53.1: 187136,
        54.1: 138432,
        55.1: 373760,
        56.1: 186816,
        57.1: 227648,
        58.1: 54824,
        59.1: 245568,
        60.4: 12554,
        62.0: 9540,
        63.1: 19592,
        64.1: 11550,
        65.1: 167872,
        66.1: 86688,
        67.1: 338624,
        68.1: 375552,
        69.1: 107664,
        70.1: 169408,
        71.1: 49632,
        72.1: 13939,
        73.1: 11960,
        74.1: 54200,
        75.2: 56536,
        76.2: 170240,
        77.1: 2643968,
        78.1: 281664,
        79.1: 233280,
        80.1: 225536,
        81.1: 782848,
        82.1: 5759488,
        83.1: 2654720,
        84.1: 294464,
        85.1: 27296,
        86.1: 7305,
        87.1: 9151,
        88.1: 1381,
        89.1: 5529,
        91.1: 337088,
        92.1: 84584,
        93.1: 355520,
        94.1: 2814464,
        95.1: 367680,
        96.1: 1986560,
        97.1: 912000,
        98.1: 94840,
        99.1: 18944,
        100.1: 82256,
        101.1: 16440,
        102.1: 5788,
        103.2: 14912,
        105.1: 2570240,
        106.1: 268928,
        107.1: 129320,
        108.1: 392128,
        109.1: 85568,
        110.1: 160384,
        111.1: 32944,
        112.1: 13292,
        113.1: 10521,
        114.1: 30384,
        115.1: 20952,
        116.1: 6318,
        117.1: 21584,
        118.1: 44608,
        119.1: 299456,
        120.1: 143296,
        121.1: 75312,
        122.1: 808832,
        123.1: 146944,
        124.1: 93408,
        125.1: 39992,
        126.1: 34816,
        127.1: 9129,
        128.1: 12076,
        129.1: 3622,
        130.0: 4652,
        131.1: 5649,
        132.1: 31280,
        133.1: 26688,
        134.1: 20152,
        135.1: 51856,
        136.1: 31912,
        137.2: 8003,
        138.1: 67672,
        139.1: 17312,
        140.1: 103752,
        141.1: 13390,
        142.1: 17632,
        143.1: 3970,
        144.0: 2259,
        145.0: 1412,
        146.2: 1898,
        147.2: 3688,
        148.1: 33536,
        149.2: 15101,
        150.1: 307904,
        151.2: 53920,
        152.1: 318208,
        153.1: 67952,
        154.1: 133632,
        155.1: 260096,
        156.1: 42752,
        157.1: 5169,
        158.1: 2326,
        159.1: 2914,
        160.2: 9063,
        161.1: 1602,
        162.1: 4249,
        163.3: 1123,
        164.1: 10785,
        166.1: 325888,
        167.1: 37096,
        168.1: 16544,
        169.2: 3320,
        170.1: 26552,
        171.1: 3281,
        172.2: 1399,
        173.2: 747,
        174.1: 650,
        175.3: 348,
        176.3: 485,
        178.2: 2381,
        180.2: 202560,
        181.2: 580544,
        182.2: 6546944,
        183.2: 1015296,
        184.2: 94720,
        185.2: 7623,
        186.1: 1616,
        187.1: 609,
        188.1: 1504,
        189.1: 407,
        190.1: 3669,
        191.0: 1019,
        192.0: 229,
        193.0: 494,
        193.9: 334,
        195.2: 439,
        196.2: 3481,
        198.2: 1127936,
        199.2: 136128,
        200.2: 29816,
        201.1: 3195,
        202.1: 955,
        204.1: 5498,
        205.1: 823,
        207.1: 2823,
        208.1: 728,
        209.1: 490,
        212.1: 440,
        213.4: 425,
        214.1: 8930,
        215.2: 1353,
        216.1: 1147,
        217.2: 214,
        221.2: 329,
        222.1: 21864,
        223.2: 2924,
        224.1: 576,
        226.2: 437,
        227.1: 205,
        227.9: 562,
        230.1: 2084,
        231.1: 700,
        232.0: 207,
        242.1: 6743,
        243.2: 2586,
        244.2: 61736,
        245.2: 11048,
        246.1: 1129,
        247.3: 163,
        249.0: 218,
        251.0: 195,
        254.1: 217,
        257.2: 220,
        258.3: 2325,
        259.2: 25280,
        260.2: 7229,
        261.1: 1067,
        261.9: 283,
        267.1: 204,
        269.3: 285,
        272.2: 980544,
        273.2: 183552,
        274.2: 28104,
        275.2: 5651,
        281.0: 1145,
        283.1: 261,
        284.3: 188,
        285.2: 151,
        285.9: 181,
        288.2: 14665,
        289.1: 2237,
        290.1: 403,
        299.9: 462,
        303.2: 2478080,
        304.2: 508864,
        305.2: 69552,
        306.2: 7043,
        307.1: 742,
        341.1: 151,
        355.0: 227,
        356.0: 196,
      };

      function cosineSimilarity(vecA, vecB) {
        let dot = 0;
        let magA = 0;
        let magB = 0;

        for (let i = 0; i < vecA.length; i++) {
          dot += vecA[i] * vecB[i];
          magA += vecA[i] * vecA[i];
          magB += vecB[i] * vecB[i];
        }

        if (magA === 0 || magB === 0) return 0;
        return dot / (Math.sqrt(magA) * Math.sqrt(magB));
      }

      const spectrumFiles = {}; // store sampleID => spectrum text

      let referenceChart, sampleChart;

      function validateUploads() {
        const single = [...document.getElementById("single-upload").files];
        const batch = [...document.getElementById("batch-upload").files];
        const files = [...single, ...batch];
        const error = document.getElementById("error-message");
        error.style.display = "none";

        if (
          (single.length > 0 && single.length !== 2) ||
          (batch.length > 0 && batch.length % 2 !== 0)
        ) {
          error.textContent = "Upload both CHROMTAB and SPECTRUM files.";
          error.style.display = "block";
          return;
        }

        const grouped = {};
        for (let file of files) {
          const sampleNum = file.name.match(/S(\d+)/i)?.[1];
          if (!sampleNum) continue;
          const id = `S${sampleNum}`;
          grouped[id] = grouped[id] || {};
          if (file.name.toUpperCase().includes("CHROMTAB"))
            grouped[id].chrom = file;
          if (file.name.toUpperCase().includes("SPECTRUM"))
            grouped[id].spectrum = file;
        }

        Object.entries(grouped).forEach(([id, pair]) => {
          if (pair.chrom && pair.spectrum) {
            Promise.all([readFile(pair.chrom), readFile(pair.spectrum)]).then(
              ([chromData, specData]) => {
                const { maxAbundance, retentionTime } =
                  getMaxFromChrom(chromData);
                spectrumFiles[id] = specData; // Save spectrum for chart later
                chromFiles[id] = chromData; // ✅ store CHROMTAB content

                const drugType = matchCocaine(specData) ? "Cocaine" : "Unknown";
                addToTable(id, drugType, retentionTime, maxAbundance);
              }
            );
          }
        });
      }

      function readFile(file) {
        return new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = rej;
          reader.readAsText(file);
        });
      }

      function getMaxFromChrom(text) {
        const lines = text.trim().split("\n").slice(3);
        let max = -Infinity,
          rt = 0;
        for (let line of lines) {
          const [t, val] = line.trim().split(/[,\t ]+/);
          const numVal = parseFloat(val);
          if (numVal > max) {
            max = numVal;
            rt = parseFloat(t);
          }
        }
        return { maxAbundance: max, retentionTime: rt };
      }

      function matchCocaine(text) {
        const lines = text.trim().split("\n").slice(4);
        const sampleSpectrum = {};
        for (let line of lines) {
          const [mz, ab] = line.trim().split(/[,\t ]+/);
          if (mz && ab)
            sampleSpectrum[parseFloat(mz).toFixed(1)] = parseFloat(ab);
        }

        const cocainePeaks = [77, 82.1, 94.1, 105, 122.1, 182.1, 303.1];
        let markerMatchScore = 0;
        const tolerance = 0.5;
        const maxAb = Math.max(...Object.values(sampleSpectrum));

        for (let refMz of cocainePeaks) {
          for (let mz in sampleSpectrum) {
            const diff = Math.abs(refMz - parseFloat(mz));
            if (diff <= tolerance) {
              const norm = sampleSpectrum[mz] / maxAb;
              if (norm > 0.05) markerMatchScore += 1;
              break;
            }
          }
        }

        // -----------------------------
        // Now do full-spectrum comparison
        const refLabels = Object.keys(referenceSpectrum)
          .map((mz) => parseFloat(mz).toFixed(1))
          .sort((a, b) => a - b);

        const sampleData = refLabels.map((mz) => sampleSpectrum[mz] || 0);
        const referenceData = refLabels.map(
          (mz) => referenceSpectrum[parseFloat(mz)] || 0
        );

        const normSample = sampleData.map((v) => v / Math.max(...sampleData));
        const normRef = referenceData.map(
          (v) => v / Math.max(...referenceData)
        );

        const similarity = cosineSimilarity(normSample, normRef);
        const matchPercent = similarity * 100;

        // -----------------------------
        // Final classification logic:
        return markerMatchScore >= 4 && matchPercent >= 85;
      }

      function addToTable(id, drug, rt, abundance) {
        const row = document.createElement("tr");

        // Get case ID from input
        const caseID = document.getElementById("case-id-input").value || "N/A";

        // Compute spectrum similarity
        const sampleText = spectrumFiles[id];
        const lines = sampleText.trim().split("\n").slice(4);
        const sampleSpectrum = {};
        for (let line of lines) {
          const [mz, ab] = line.trim().split(/[,\t ]+/);
          if (mz && ab) {
            sampleSpectrum[parseFloat(mz).toFixed(1)] = parseFloat(ab);
          }
        }

        const refLabels = Object.keys(referenceSpectrum)
          .map((mz) => parseFloat(mz).toFixed(1))
          .sort((a, b) => a - b);

        const sampleData = refLabels.map((mz) => sampleSpectrum[mz] || 0);
        const referenceData = refLabels.map(
          (mz) => referenceSpectrum[parseFloat(mz)] || 0
        );

        const normSample = sampleData.map((v) => v / Math.max(...sampleData));
        const normRef = referenceData.map(
          (v) => v / Math.max(...referenceData)
        );

        const simScore = cosineSimilarity(normSample, normRef);
        const matchPercent = (simScore * 100).toFixed(2);

        // Add row to new samples table
        row.innerHTML = `
    <td>${caseID}</td>
    <td>${id}</td>
    <td>${drug}</td>
    <td>${rt.toFixed(3)}</td>
    <td>${abundance}</td>
    <td>${matchPercent}%</td>`;

        row.onclick = () => updateSampleChart(id);
        document.querySelector("#results-table tbody").appendChild(row);

        // Show "Save Sample(s)?" button if rows exist
        document.getElementById("save-button").style.display = "inline-block";
        document.getElementById("print-button").style.display = "inline-block";
      }

      function initCharts() {
        const refData = Object.entries(referenceSpectrum).map(([mz, ab]) => ({
          mz: parseFloat(mz),
          ab,
        }));
        refData.sort((a, b) => a.mz - b.mz);

        const refLabels = refData.map((d) => d.mz.toFixed(1));
        const refValues = refData.map((d) => d.ab);

        const top10Indices = [...refValues]
          .map((ab, i) => ({ ab, i }))
          .sort((a, b) => b.ab - a.ab)
          .slice(0, 10)
          .map((obj) => obj.i);

        referenceChart = new Chart(
          document.getElementById("referenceChart").getContext("2d"),
          {
            type: "bar",
            data: {
              labels: refLabels,
              datasets: [
                {
                  label: "Abundance",
                  data: refValues,
                  backgroundColor: "rgba(0,123,255,0.6)", // BLUE
                },
              ],
            },
            options: {
              plugins: {
                datalabels: {
                  color: "#000",
                  align: "end",
                  anchor: "end",
                  display: function (context) {
                    return top10Indices.includes(context.dataIndex);
                  },
                  formatter: function (value, context) {
                    return context.chart.data.labels[context.dataIndex]; // m/z label
                  },
                },
                legend: { display: false },
                font: {
                  size: 8, // 👈 You can change this number (e.g., 8, 10, 12)
                },
              },
              scales: {
                x: { title: { display: true, text: "m/z" } },
                y: { title: { display: true, text: "Abundance" } },
              },
            },
            plugins: [ChartDataLabels],
          }
        );

        sampleChart = new Chart(
          document.getElementById("sampleChart").getContext("2d"),
          {
            type: "bar",
            data: {
              labels: refLabels,
              datasets: [
                {
                  label: "Abundance",
                  data: Array(refLabels.length).fill(0),
                  backgroundColor: "rgba(255,165,0,0.6)", // ORANGE
                },
              ],
            },
            options: {
              plugins: {
                datalabels: {
                  color: "#000",
                  align: "end",
                  anchor: "end",
                  display: false,
                  formatter: function (value, context) {
                    return context.chart.data.labels[context.dataIndex]; // m/z label
                  },
                },
                legend: { display: false },
              },
              scales: {
                x: { title: { display: true, text: "m/z" } },
                y: { title: { display: true, text: "Abundance" } },
              },
            },
            plugins: [ChartDataLabels],
          }
        );
      }

      function updateSampleChart(sampleID) {
        latestSampleID = sampleID;

        const text = spectrumFiles[sampleID];
        const lines = text.trim().split("\n").slice(4);
        const sampleSpectrum = {};

        for (let line of lines) {
          const [mz, ab] = line.trim().split(/[,\t ]+/);
          if (mz && ab) {
            sampleSpectrum[parseFloat(mz).toFixed(1)] = parseFloat(ab);
          }
        }

        const refLabels = referenceChart.data.labels;
        const alignedData = refLabels.map((mz) => {
          const key = parseFloat(mz).toFixed(1);
          return sampleSpectrum[key] || 0;
        });

        sampleChart.data.labels = refLabels;
        sampleChart.data.datasets[0].data = alignedData;
        sampleChart.data.datasets[0].backgroundColor = "rgba(255,165,0,0.6)"; // keep orange

        // Get top 10 peak indices
        const top10Indices = [...alignedData]
          .map((ab, i) => ({ ab, i }))
          .sort((a, b) => b.ab - a.ab)
          .slice(0, 10)
          .map((obj) => obj.i);

        // Count signature markers matched
        const cocainePeaks = [77, 82.1, 94.1, 105, 122.1, 182.1, 303.1];
        let matchedMarkers = 0;
        const tolerance = 0.5;
        const maxAb = Math.max(...alignedData);

        const chromText = chromFiles[sampleID];

        const chromLines = chromText.trim().split("\n");
        const rowCount = chromLines.length - 3; // skip header lines
        const infoDiv = document.getElementById("info-mode-container");

        infoDiv.innerHTML = `
  <div style="font-size: 16px; line-height: 1.5;">
    Sample <strong>${sampleID}</strong> contained <strong>${rowCount}</strong> rows of data, 
    from which a maximum abundance of <strong>${maxAb}</strong> was retrieved, 
    this is the total intensity of a detected substance in forensic drug testing. 
    A retention time of <strong>${
      refLabels[alignedData.indexOf(maxAb)]
    }</strong> was found, 
    which is the time it takes for a compound to travel through the chromatography column.
  </div>
`;

        for (let refMz of cocainePeaks) {
          for (let i = 0; i < refLabels.length; i++) {
            const mz = parseFloat(refLabels[i]);
            if (
              Math.abs(mz - refMz) <= tolerance &&
              alignedData[i] / maxAb > 0.05
            ) {
              matchedMarkers++;
              break;
            }
          }
        }

        // Normalize aligned data for cosine comparison
        const sampleNorm = alignedData.map((v) => v / Math.max(...alignedData));
        const refNorm = referenceChart.data.datasets[0].data.map(
          (v) => v / Math.max(...referenceChart.data.datasets[0].data)
        );

        // Calculate cosine similarity
        const simScore = cosineSimilarity(sampleNorm, refNorm);
        const matchPercent = (simScore * 100).toFixed(2);

        document.getElementById("match-info").innerHTML =
          `Full Spectrum Match: ${matchPercent}%<br>` +
          `Matched ${matchedMarkers} out of 7 signature markers within ±0.5 m/z`;

        // Show only labels for top 10
        sampleChart.options.plugins.datalabels.display = function (context) {
          return top10Indices.includes(context.dataIndex);
        };

        // Show m/z value as label
        sampleChart.options.plugins.datalabels.formatter = function (
          value,
          context
        ) {
          return context.chart.data.labels[context.dataIndex]; // m/z value
        };

        sampleChart.update();
        updateModeView();
      }

      function saveSamplesLocally() {
        const rows = document.querySelectorAll("#results-table tbody tr");
        const allSamplesTable = document.querySelector(
          "#all-samples-table tbody"
        );

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          const tr = document.createElement("tr");

          // Create new row with submission time
          for (let i = 0; i < 5; i++) {
            const td = document.createElement("td");
            td.textContent = cells[i].textContent;
            tr.appendChild(td);
          }

          // Add submission time
          const timestamp = new Date().toLocaleString();
          const tdTime = document.createElement("td");
          tdTime.textContent = timestamp;
          tr.appendChild(tdTime);

          // Prepend row to top of All Samples table
          allSamplesTable.insertBefore(tr, allSamplesTable.firstChild);
        });

        // ✅ Call updateCaseFilter() to update dropdown dynamically
        updateCaseFilter();

        alert("Sample(s) added to All Samples!");
      }

      function updateCaseFilter() {
        const rows = document.querySelectorAll("#all-samples-table tbody tr");
        const caseSet = new Set();

        // Collect unique Case IDs from All Samples table
        rows.forEach((row) => {
          const caseID = row.children[0].textContent; // Case ID is in the first column
          if (caseID) {
            caseSet.add(caseID);
          }
        });

        // Get the case filter dropdown
        const caseFilter = document.getElementById("case-filter");

        // Clear existing options except 'All'
        const defaultOption = caseFilter.querySelector("option[value='']");
        caseFilter.innerHTML = ""; // Clear all options
        caseFilter.appendChild(defaultOption); // Add back the default 'All' option

        // Add unique case IDs as new options
        caseSet.forEach((caseID) => {
          const option = document.createElement("option");
          option.value = caseID;
          option.textContent = caseID;
          caseFilter.appendChild(option);
        });
      }

      const initialSamples = [
        ["C1", "S1", "Cocaine", 16.441, 39398596, "4/28/2022 1:35:00 PM"],
        ["C1", "S2", "Cocaine", 15.72, 150864944, "12/16/2022 7:34:00 PM"],
        ["C1", "S3", "Cocaine", 16.211, 11632325, "2/21/2022 2:49:00 PM"],
        ["C1", "S4", "Cocaine", 15.463, 25371720, "4/11/2022 02:26:00 PM"],
        ["C1", "S5", "Cocaine", 15.149, 3080717, "1/09/2022 03:18:00 PM"],
        ["C2", "S6", "Cocaine", 16.444, 39398596, "5/29/2022 7:35:00 PM"],
        ["C2", "S7", "Cocaine", 15.92, 458923852, "12/30/2022 8:13:00 PM"],
        ["C2", "S8", "Cocaine", 16.455, 32857482, "5/31/2022 12:00:00 PM"],
        ["C4", "S9", "Cocaine", 15.457, 57296846, "1/20/2022 9:20:00 PM"],
        ["C4", "S10", "Cocaine", 15.423, 113748525, "1/07/2022 8:34:00 PM"],
        ["C1", "S11", "Heroin", 20.132, 869472714, "4/22/2022 8:26:00 PM"],
        ["C1", "S12", "Heroin", 21.967, 294958194, "03/15/2022 4:49:00 PM"],
        ["C1", "S13", "Heroin", 20.136, 973718485, "05/20/2022 4:20:00 PM"],
        ["C2", "S14", "Heroin", 20.142, 1253547582, "4/03/2022 7:59:00 PM"],
        ["C2", "S15", "Heroin", 20.563, 8883747569, "8/11/2022 6:39:00 PM"],
        [
          "C2",
          "S16",
          "Methamphetamine",
          10.934,
          86927247692,
          "09/18/2022 4:26:00 PM",
        ],
        [
          "C3",
          "S17",
          "Methamphetamine",
          11.867,
          637288582,
          "05/31/2022 6:00:00 PM",
        ],
        [
          "C3",
          "S18",
          "Methamphetamine",
          10.921,
          1234958295,
          "08/23/2022 7:11:00 AM",
        ],
        [
          "C4",
          "S19",
          "Methamphetamine",
          11.572,
          43285729384,
          "10/22/2022 7:26:00 PM",
        ],
        [
          "C4",
          "S20",
          "Methamphetamine",
          10.822,
          76463837587,
          "09/30/2022 8:26:00 PM",
        ],
      ];

      function loadInitialSamples() {
        const table = document.querySelector("#all-samples-table tbody");
        initialSamples.forEach((row) => {
          const tr = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell;
            tr.appendChild(td);
          });

          table.appendChild(tr);
        });
      }

      // Initialize empty charts
      window.onload = () => {
        initCharts();
        loadInitialSamples();
        updateCaseFilter(); // ✅ Add this to load Case IDs on page load
      };

      const selectedDrugs = new Set();

      document.querySelectorAll(".drug-pill").forEach((pill) => {
        pill.addEventListener("click", () => {
          const drug = pill.dataset.drug;

          // Toggle active class
          pill.classList.toggle("active");

          // Update selectedDrugs set
          if (selectedDrugs.has(drug)) {
            selectedDrugs.delete(drug);
          } else {
            selectedDrugs.add(drug);
          }

          filterSamplesTable();
        });
      });

      function filterSamplesTable() {
        const rows = document.querySelectorAll("#all-samples-table tbody tr");
        let visibleCount = 0;

        // Get selected case from dropdown
        const selectedCase = document.getElementById("case-filter").value;

        rows.forEach((row) => {
          const caseID = row.children[0].textContent; // Case ID is now in the first column
          const drugType = row.children[2].textContent; // Drug Type remains in column 2

          // Check if case filter matches or if nothing is selected
          const matchesCase = !selectedCase || caseID === selectedCase;

          // Check if drug filter matches or no filter selected
          const matchesDrug =
            selectedDrugs.size === 0 || selectedDrugs.has(drugType);

          // Show row only if both case and drug filters match
          if (matchesCase && matchesDrug) {
            row.style.display = "";
            visibleCount++;
          } else {
            row.style.display = "none";
          }
        });

        // Update sample count display
        document.getElementById("sample-count").textContent = visibleCount;
      }

      let selectedReferenceSample = null;

      document
        .querySelector("#all-samples-table")
        .addEventListener("click", (e) => {
          const row = e.target.closest("tr");
          if (!row || !row.parentElement) return;

          // Remove existing highlight
          document
            .querySelectorAll("#all-samples-table tbody tr")
            .forEach((r) => {
              r.classList.remove("selected-sample-row");
            });

          // Add green highlight
          row.classList.add("selected-sample-row");

          // Store reference retention time
          const retentionTime = parseFloat(row.children[2].textContent);
          selectedReferenceSample = retentionTime;

          updateFoundMatchesTable();
        });

      document
        .getElementById("variance-slider")
        .addEventListener("input", () => {
          const val = parseFloat(
            document.getElementById("variance-slider").value
          );
          document.getElementById("variance-value").textContent =
            val.toFixed(1);
          document.getElementById("variance-display-label").textContent =
            val.toFixed(1);

          updateFoundMatchesTable(); // live update
        });

      function updateFoundMatchesTable() {
        const refTime = selectedReferenceSample;
        if (refTime === null) return;

        const variance = parseFloat(
          document.getElementById("variance-slider").value
        );
        const allRows = document.querySelectorAll(
          "#all-samples-table tbody tr"
        );
        const foundTable = document.querySelector("#found-matches-table tbody");

        // Clear old matches
        foundTable.innerHTML = "";

        let matchCount = 0; // ✅ Declare this

        allRows.forEach((row) => {
          const rt = parseFloat(row.children[2].textContent);

          // Skip if hidden or reference sample itself
          if (row.style.display === "none" || rt === refTime) return;

          const diff = Math.abs(refTime - rt);
          if (diff <= variance) {
            const clone = row.cloneNode(true);

            const diffCell = document.createElement("td");
            diffCell.textContent = diff.toFixed(3);
            clone.appendChild(diffCell);

            foundTable.appendChild(clone);
            matchCount++; // ✅ This now works
          }
        });

        // ✅ Update display
        document.getElementById("match-count").textContent = matchCount;
        document.getElementById("variance-display-label").textContent =
          variance.toFixed(1);
      }

      function printReport() {
        const rows = document.querySelectorAll("#results-table tbody tr");
        if (rows.length === 0) return;

        const date = new Date().toLocaleDateString();
        const badgeID = "12345";

        let reportHTML = `
    <html>
    <head><style>
      body { font-family: Arial; font-size: 12pt; }
      h1, h2 { text-align: center; font-size: 14pt; font-weight: bold; }
      .subhead { font-size: 12pt; font-weight: bold; text-align: left; margin-top: 10px; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12pt; text-align: center; }
      th, td { border: 1px solid #000; padding: 5px; }
    </style></head>
    <body>
  <div style="border: 2px solid black; padding: 30px;">

    <h1>DUBAI POLICE</h1>
    <h1>Forensic Mass Spectrum Analysis</h1>
    <div class="subhead">Date: ${date}</div>
    <div class="subhead">Badge ID: ${badgeID}</div>
    <div class="subhead" style="margin-top: 20px;">Comments:</div>
    <br> <br>
    <div style="margin-left: 10px;">The following new samples were successfully identified:</div>
    <br>

    <table>
      <tr>
        <th>Case ID</th>
        <th>Sample ID</th>
        <th>Drug Type</th>
        <th>Retention Time</th>
        <th>Maximum Abundance</th>
        <th>Spectrum Match %</th>
      </tr>`;

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          reportHTML += `<tr>${[...cells]
            .map((td) => `<td>${td.textContent}</td>`)
            .join("")}</tr>`;
        });

        reportHTML += `
      </table>
      <div style="margin-top: 80px; text-align: center;">
        _________________________________________<br>
        Signature
      </div>
      </div>
    </body></html>`;

        const blob = new Blob(["\ufeff", reportHTML], {
          type: "application/msword",
        });

        saveAs(blob, `Forensic_Report_${date.replace(/\//g, "-")}.doc`);
      }

      let currentMode = "info";

      let latestSampleID = null;

      document.querySelectorAll(".mode-pill").forEach((pill) => {
        pill.addEventListener("click", () => {
          document
            .querySelectorAll(".mode-pill")
            .forEach((p) => p.classList.remove("active"));
          pill.classList.add("active");
          currentMode = pill.dataset.mode;
          updateModeView();
        });
      });

      function updateModeView() {
        document.getElementById("chart-mode-container").style.display =
          currentMode === "spectrum" ? "block" : "none";
        document.getElementById("info-mode-container").style.display =
          currentMode === "info" ? "block" : "none";
        document.getElementById("peaks-mode-container").style.display =
          currentMode === "peaks" ? "block" : "none";

        if (currentMode === "peaks" && latestSampleID) {
          updatePeaksView(latestSampleID); // ✅ render peaks table & chart
        }
      }

      document
        .querySelector("#results-table tbody")
        .addEventListener("click", (e) => {
          const row = e.target.closest("tr");
          if (!row) return;
          const sampleID = row.children[1].textContent;
          updateSampleChart(sampleID); // 🔁 this triggers both chart and info view update
        });

      let peaksChart = null;

      function updatePeaksView(sampleID) {
        const chromData = chromFiles[sampleID];
        const numPeaks = parseInt(
          document.getElementById("peaks-dropdown").value
        );
        const lines = chromData.trim().split("\n").slice(3); // skip headers

        const data = lines.map((line) => {
          const [rt, ab] = line.trim().split(/[,\t ]+/);
          return { rt: parseFloat(rt), ab: parseFloat(ab) };
        });

        const sorted = [...data].sort((a, b) => b.ab - a.ab);
        const top = sorted.slice(0, numPeaks);
        const tbody = document.querySelector("#peaks-table tbody");
        tbody.innerHTML = "";

        top.forEach((row, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${i + 1}</td><td>${row.ab}</td><td>${
            row.rt
          }</td>`;
          tr.addEventListener("click", () => highlightPeak(row.rt, row.ab));
          tbody.appendChild(tr);
        });

        // Plot top 50 points
        // Plot top 50 points sorted by retention time (ascending)
        const top50 = [...data].sort((a, b) => b.ab - a.ab).slice(0, 30);
        top50.sort((a, b) => a.rt - b.rt); // 🔁 sort by RT ascending

        const labels = top50.map((d) => d.rt.toFixed(3));
        const values = top50.map((d) => d.ab);

        const bgColors = Array(50).fill("rgba(0, 123, 255, 0.6)");

        if (peaksChart) peaksChart.destroy();

        peaksChart = new Chart(
          document.getElementById("peaksChart").getContext("2d"),
          {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Abundance",
                  data: values,
                  backgroundColor: bgColors,
                },
              ],
            },
            options: {
              scales: {
                x: { title: { display: true, text: "Retention Time" } },
                y: { title: { display: true, text: "Abundance" } },
              },
            },
          }
        );

        // Store for row highlight
        peaksChart._highlightColors = bgColors;
        peaksChart._highlightLabels = labels;
      }

      document
        .getElementById("peaks-dropdown")
        .addEventListener("change", () => {
          if (latestSampleID) updatePeaksView(latestSampleID);
        });

      function highlightPeak(rt, ab) {
        const index = peaksChart._highlightLabels.findIndex(
          (label) => parseFloat(label) === parseFloat(rt.toFixed(3))
        );
        if (index !== -1) {
          const newColors = [...peaksChart._highlightColors].fill(
            "rgba(0, 123, 255, 0.6)"
          );
          newColors[index] = "red";
          peaksChart.data.datasets[0].backgroundColor = newColors;
          peaksChart.update();
        }
      }

      // Add event listener to case filter dropdown
      document
        .getElementById("case-filter")
        .addEventListener("change", filterSamplesTable);
    </script>
  </body>
</html>
